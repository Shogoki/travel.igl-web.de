<!-- post list -->
{{ $url := .Site.Params.icloud_api }}
<script>
    console.log("URL: '{{$url}}'")
     function setFeaturedImage(id,index,album) {  
                const el = document.getElementById(`featured-image-${index}`);
                const oldImg = el.querySelector("img")
                const oldGUID = oldImg.getAttribute("data-guid")
                // console.log("old image", oldImg)
                
                const url = "{{ $url }}"
                fetch(`${url}/album/${album}`).then(res => res.json().then(images => {
                    if(images && images.length >= id) {
                        if(oldGUID !== images[id].guid) {
                            console.log("Image GUID differs, replacing image")
                            if(oldImg) {
                               el.removeChild(oldImg)
                            }
                            const img = document.createElement("img")
                            img.src = images[id].thumbnailUrl
                            img.alt = images[id].caption
                            img.setAttribute("data-guid") = images[id].guid
                            el.appendChild(img)
                        }
                        else {
                            console.log("Did not replace image as it is the same")
                        }
                    }
                }));
            }
</script>
{{ range $index, $element := $.Paginator.Pages }}
<div class="post-preview">
    <a href="{{ .Permalink }}">
        <h2 class="post-title">
            {{ .Title }}
        </h2>
	{{with .Params.subtitle }}
        <h3 class="post-subtitle">
            {{ . }}
        </h3>
	{{ end }}
    {{ $album :=  .Params.album }}
   {{ $albumData :=  index site.Data.albums (printf "%s" $album) }}
    {{with .Params.featured }}
        {{$featured := .}}
        <div id="featured-image-{{ $index }}" >
            {{range $idx, $data := $albumData}}
                {{if eq $idx $featured}}
                <img data-guid="{{$data.guid}}" src="{{$data.thumbnailUrl}}" alt="{{$data.caption}}" />
                {{end}}
            {{end}}
        </div>
        <script>
            setFeaturedImage(parseInt("{{$featured}}"), "{{$index}}", "{{$album}}");
        </script>
    {{ end }}
        <div class="post-content-preview">
	{{ with .Description }}
            {{ . }}
        {{ else }}
            {{ .Summary}}
       {{ end }}
        </div>
    </a>
    <p class="post-meta">
    {{ if .Params.metadata }}
        {{ range $index, $element := .Params.metadata }}
            {{ if .link }}
                <a href="{{ .link }}">{{ .text }}</a>
            {{ else }}
                {{ .text }}
            {{ end }}
        {{ end }}
    {{ else }}
        geposted von {{ with .Params.author }}{{ . }}{{ else }}{{ .Site.Title }}{{ end }} am {{ index site.Data.days_german (printf "%s" .Date.Weekday) }}, {{ .Date.Day }}. {{ index site.Data.months_german (printf "%d" .Date.Month) }} {{ .Date.Year }}

       
        <!-- Don't show "Last Modified on" if update happened on the same day. -->
        {{ if (and (not .Lastmod.IsZero) (not (eq (dateFormat "2006-01-02" .Lastmod) (dateFormat "2006-01-02" .Date)))) }}
            <br>Last Modified on {{ dateFormat "Monday, January 2, 2006" .Params.LastMod }} 
        {{ end }}
    {{ end }}
    </p>

</div>
<hr>
{{ end }}
